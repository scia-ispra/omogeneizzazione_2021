---
title: Anomalie annuali di temperatura media
date: "`r Sys.Date()`"
output: html_document
---

```{r intro,include=FALSE,warning=FALSE,message=FALSE,echo=FALSE}
library("tidyverse")
library("echarts4r")
library("DT")
library("knitr")

PARAM<-"tmean"

knitr::opts_chunk$set(fig.width = 16,fig.height = 10,message = FALSE,error = FALSE,warning = FALSE,echo=FALSE)

list.files(pattern =glue::glue("^anom_tmax.+"),path = "../tmax/",full.names = TRUE)->ffile
ffile[grep("acmant",ffile)]->file_old
ffile[grep(glue::glue("cluster_tmax"),ffile)]->file_cluster_param
ffile[grep(glue::glue("cluster_tmean"),ffile)]->file_cluster_tmean


read_delim(file_old,delim=";",col_names = TRUE) %>%
  mutate(tipo="old")->dati_old

read_delim(file_cluster_param,delim=";",col_names = TRUE) %>%
  mutate(tipo="cluster_param")->dati_cluster_param

read_delim(file_cluster_tmean,delim=";",col_names = TRUE) %>%
  mutate(tipo="cluster_tmean")->dati_cluster_tmean

bind_rows(dati_old,dati_cluster_param,dati_cluster_tmean) %>%
  dplyr::select(-anomAnnuale)->dati

dati$param<-"tmax"
names(dati)[2]<-"tmax"


list.files(pattern =glue::glue("^anom_tmin.+"),path="../tmin",full.names = TRUE)->ffile
ffile[grep("acmant",ffile)]->file_old
ffile[grep(glue::glue("cluster_tmin"),ffile)]->file_cluster_param
ffile[grep(glue::glue("cluster_tmean"),ffile)]->file_cluster_tmean

read_delim(file_old,delim=";",col_names = TRUE) %>%
  mutate(tipo="old")->dati_old

read_delim(file_cluster_param,delim=";",col_names = TRUE) %>%
  mutate(tipo="cluster_param")->dati_cluster_param


read_delim(file_cluster_tmean,delim=";",col_names = TRUE) %>%
  mutate(tipo="cluster_tmean")->dati_cluster_tmean

bind_rows(dati_old,dati_cluster_param,dati_cluster_tmean) %>%
  dplyr::select(-anomAnnuale)->dati2

dati2$param<-"tmin"
names(dati2)[2]<-"tmin"

left_join(dati %>% dplyr::select(-param),dati2 %>% dplyr::select(-param)) %>%
  mutate(tmean=(tmax+tmin)/2) %>%
  dplyr::select(-tmax,-tmin) %>%
  mutate(tmean=round(tmean,2)) %>%
  spread(key=tipo,value=tmean)->sdati
```

<br>

**Verifica delle serie di anomalia annuale di temperatura `media`.**

Nei grafici che seguono:

- **old**: serie di temperatura pubblicata nel rapporto `Gli Indicatori del clima in Italia nel 2020`

- **cluster_param**: serie di temperatura utilizzando serie giornaliere omogeneizzate dopo aver fatto una cluster analysis basata sul parametro `r PARAM`

- **cluster_param**: serie di temperatura utilizzando serie giornaliere omogeneizzate dopo aver fatto una cluster analysis basata sul parametro `tmean`

<br>

L'omogeneizzazione e' stata svolta mediante il pacchetto `Climatol` su serie giornaliere clusterizzate in base al parametro`r PARAM` e in base al parametro `tmean`. In entrambi i casi la cluster analysis ha portato all'identificazione di sei clusters. Qui di seguito vengono confrontati i dati pubblicati sul rapporto `Gli Indicatori del Clima nel 2020` con i risultati dell'omogeneizzazione utilizzando i due diversi criteri di cluster analysis.

<br>



<br>

### Tabella con valori di anomalia annuale

```{r tabella,include=TRUE}

sdati %>% rename(Anno=yy)->gdati

datatable(gdati,options=list(pageLength=30)) %>% DT::formatStyle("old",backgroundColor = "#C3C3C3")
```


<br>

### Ranking dei valori di anomalia annuale

<br>

```{r,include=TRUE}

purrr::partial(.f=base::rank,ties.method="first")->myrank

datatable(gdati %>% mutate(old=myrank(old),
                           cluster_param=myrank(cluster_param),
                           cluster_tmean=myrank(cluster_tmean)),options=list(pageLength=30)) %>% DT::formatStyle("old",backgroundColor = "#C3C3C3")
```

<br>

### Grafico delle serie delle anomalie annuali

PS: grafico alla fine per evitare problemi tra `echarts4r` e `DT`.

```{r grafico,include=TRUE}
label <- list(
    formatter = htmlwidgets::JS(
        'function(value, index){
            return value;
        }'
    )
)

e_charts(data=sdati ,x=yy) %>% 
  e_bar(old,colorBy="data") %>% 
  e_line(serie = cluster_param) %>%
  e_line(serie=cluster_tmean) %>%
  e_tooltip(trigger="axis",
            formatter =htmlwidgets::JS(
              "function(params){
                var tp = [];
                params.forEach(function(x){
                  tp.push([x.seriesName, x.value].join('-'))
                });
                return(tp.join('<br/>'))
              }")) %>%
  e_x_axis(serie = yy,axisLabel=label) %>%
  e_y_axis(name="Â°C") %>%
  e_visual_map(serie=old,type="piecewise",pieces=list(list(lte=0,color="blue"),list(gt=0,color="firebrick")))
```

