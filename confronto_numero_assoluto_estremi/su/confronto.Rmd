---
title: Confronto valori assoluti summer days, serie homog vs serie raw
date: "`r Sys.Date()`"
author: Guido Fioravanti
output: html_document
---

Effetto dell'omogeneizzazione sui `summer days`.

I grafici che seguono confrontano i valori assoluti dei `summer days` per le serie omogeneizzate e le serie raw (non omogeneizzate).


```{r intro,include=FALSE,message=FALSE,echo=FALSE,warning=FALSE,error=FALSE}
rm(list=objects())
library("tidyverse")
library("echarts4r")
library("guido")
library("leaflet")

knitr::opts_chunk$set(include=TRUE,message=FALSE,echo=FALSE,warning=FALSE,error=FALSE,fig.width = 10)

leggi_file("ana_.+csv",delim=";",col_names = TRUE,output = "_dfr",col_types = cols(.default = col_character()),path="./",full.names=TRUE)->ana


read_delim("risultati_su.csv",delim=";",col_names = TRUE) %>%
  gather(key="id",value="homog",-yy)->hdati

read_delim("raw_risultati_su.csv",delim=";",col_names = TRUE) %>%
  gather(key="id",value="raw",-yy)->rdati


left_join(hdati,rdati) %>%
  mutate(decade=str_sub(yy,1,3))->df

left_join(df,ana %>% dplyr::select(-yy))->df


# ggplot(data=df,aes(x=homog,y=raw))+
#   geom_point(aes(color=cluster))+
#   geom_smooth(se=FALSE)+
#   geom_abline(slope=1,intercept=0,color="red")+
#   facet_wrap(~decade)+
#   scale_color_discrete()+
#   theme_bw()

sort(unique(df$decade))->v_decadi
v_decadi[length(v_decadi)]->ultima_decade

purrr::map(v_decadi,.f=function(DECADE){

  e_charts(df %>% filter(decade==DECADE) %>% mutate(cluster=as.character(cluster)),x = homog,elementId = DECADE) %>%
    e_scatter(serie=raw,symbol_size = 8) %>%
    e_lm(raw~homog) %>%
    e_line(serie=homog,color="black",lineStyle=list(type="solid"),symbol="none") %>%
    e_tooltip(tirgger="axis") %>%
    e_title(text=paste0("Decade: ",DECADE,".")) %>%
    e_legend(show=FALSE) %>%
    e_x_axis(name="homog") %>%
    e_y_axis(name="raw")->grafico
  
  if(DECADE==ultima_decade){
    grafico %>%
      e_connect(base::setdiff(v_decadi,ultima_decade))
  }
  
  grafico
    
  
})->listaScatter
```

Confronto tra `summer days` per decade. Ogni punto dello scatterplot rappresenta il valore calcolato per una singola stazione per un determinato anno: homog vs raw. E' evidente come l'effetto dell'omogeneizzazione sia quello di ridurre i valori dei summer days durante il trentennio 61-90.

```{r grafico1}
e_arrange(listaScatter[1:length(v_decadi)],rows=4,width="xs",cols=2)
```
  

```{r grafico2}
v_cluster<-unique(df$cluster)
v_cluster[length(v_cluster)]->ultimo_cluster

purrr::map(v_cluster,.f=function(CLUSTER){
  
  e_charts(df %>% filter(cluster==CLUSTER),x = homog,elementId = CLUSTER) %>%
    e_scatter(serie=raw,symbol_size = 8) %>%
    e_lm(raw~homog) %>%
    e_line(serie=homog,color="black",lineStyle=list(type="solid"),symbol="none") %>%
    e_tooltip(tirgger="axis") %>%
    e_title(text=paste0("Cluster: ",CLUSTER,".")) %>%
    e_legend(show=FALSE) %>%
    e_x_axis(name="homog") %>%
    e_y_axis(name="raw")->grafico
  
  if(CLUSTER==ultimo_cluster){
    grafico %>%
      e_connect(base::setdiff(v_cluster,ultimo_cluster))
  }
  
  grafico
  
  
})->listaScatter
```

I grafici confrontano i valori annuali dei summer days per i singoli punti stazione. Il cluster 2 e' un cluster di stazioni di montagna. 

```{r}
e_arrange(listaScatter[1:length(v_cluster)],rows=4,width="xs",cols=2)
```

### Valori climatologici

Qui vengono confrontrati i valori climatologici 61-90 utilizzati per calcolare le anomalie annuali. I confronto sono fatti stazione per stazione. E' evidente che i valori climatologici calcolati per le serie omogeneizzate sono piu' bassi di quelli delle serie raw.

```{r climatologici,include=TRUE}
read_delim("climatologici_su_climatol1961_1990.csv",delim=",",col_names = TRUE) %>%
  gather(key="id",value="homog")->hdati

read_delim("raw_climatologici_su_climatol1961_1990.csv",delim=",",col_names = TRUE) %>%
  gather(key="id",value="raw")->rdati

left_join(hdati,rdati)->df

left_join(df,ana %>% dplyr::select(-yy)) %>% mutate(cluster=as.character(cluster))->df

e_chart(df,x=homog) %>%
  e_scatter(serie=raw,symbol_size=8) %>%
  e_line(serie=homog,color="black",lineStyle=list(type="solid"),symbol="none") %>%
  e_x_axis(name="homog") %>%
  e_y_axis(name="raw") %>%
  e_tooltip(trigger="item")
```

Confronto tra i valori climatologici 61-90 utilizzando il parallel plot. E' evidente come molti valori, dopo l'omogeneizzazione, tendano a diminuire.

```{r parallel,include=TRUE}
e_chart(df) %>%
   e_parallel(raw,homog,opts=list(lineStyle=list(color="black",width=3,opacity=0.1))) %>%
  e_tooltip(trigger="item")

```


### Mappa climatologici serie homog

```{r mappa1,fig.height=10}

leaflet::colorNumeric(palette=scico::scico(n=15,palette="imola"),domain = seq(0,150,10),alpha=1)->paletta

df %>%
  mutate(Longitude=as.numeric(Longitude),Latitude=as.numeric(Latitude))->df

leaflet(data=df)%>%
  setView(lng=12,lat=41.5,zoom=6)%>%
  addTiles() %>%
  addCircleMarkers(lng=~Longitude,lat=~Latitude,radius=~homog/10,popup  = ~as.character(homog),label=~id,color=~paletta(homog),fillOpacity = 1,weight = 0) %>%
  addLegend(pal=paletta,values=df$homog)
```

### Mappa climatologici serie raw

```{r mappa2,fig.height=10}

df %>%
  mutate(Longitude=as.numeric(Longitude),Latitude=as.numeric(Latitude))->df

leaflet(data=df)%>%
  setView(lng=12,lat=41.5,zoom=6)%>%
  addTiles() %>%
  addCircleMarkers(lng=~Longitude,lat=~Latitude,radius=~raw/10,popup = ~as.character(raw),label=~id,color=~paletta(raw),fillOpacity = 1,weight = 0) %>%
  addLegend(pal=paletta,values=df$raw)
```